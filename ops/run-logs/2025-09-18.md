# Incident Report — 2025-09-18 (KST)

> Binance USDT-M 선물 캔들 수집 실패로 인한 거래 중단 + systemd 재시작 반복

## 요약
- **증상:** `KeyError: 'id'` 로그 다량, `coinbot@*` 유닛 Started/Stopped 반복
- **영향:** BTC/ETH 거래 미발생(루프 진입 전 정지), SOL은 재기동 소음만 다수
- **원인:** spot 거래소 클래스로 인스턴스화 + 선물 심볼 사용 → `market['id']` 없음  
- **조치:** `ccxt.binanceusdm`로 고정, 심볼 표준화(`XXX/USDT:USDT`), 재시작 정책 정리, venv 권한 보정
- **전략 파라미터 변경:** **없음** (무거래 원인은 인프라/설정 문제)

---

## 기간
- 2025-09-18 KST 전후 (수 분 ~ 수십 분 간 반복 재시작 및 무거래)

## 영향도
- BTC, ETH: **거래 0건**
- SOL: 거래 없음, 재시작 로그만 다수

## 지표/증상
- `journalctl`: `KeyError: 'id'` (ccxt `fetch_ohlcv()` 경로)
- systemd: restart counter 증가, Started/Stopped 반복

---

## 원인(RCA)
1. **거래소/심볼 불일치**
   - 인스턴스가 `ccxt.binance`(spot)로 생성된 상태에서 **선물 심볼** 사용
   - USDT-M 표준: `BTC/USDT:USDT` / 거래소 클래스: `ccxt.binanceusdm`
   - 불일치로 `market['id']` 미존재 → `KeyError('id')` → 루프 진입 불가
2. **systemd 재시작 정책 충돌**
   - 일부 드롭인에 `Restart=always` 잔존 → 정상 종료에도 즉시 재기동 → 원인 파악 방해
3. **권한 이슈(부수)**
   - `.venv` 및 `site-packages/ccxt` 권한 제한으로 간헐 PermissionError 가능성

---

## 조치 사항(오늘 적용)
### A. 선물 전용 고정 & 심볼 통일
- 코드: `ccxt.binance` → **`ccxt.binanceusdm`** 고정
- 유닛 환경변수: `SYMBOL=XXX/USDT:USDT`로 **표준화**
  - BTC: `BTC/USDT:USDT`
  - ETH: `ETH/USDT:USDT`
  - SOL: `SOL/USDT:USDT`

### B. systemd 재시작 정책 일원화
- 최종 드롭인(`zzz-restart-policy.conf`):
  - `Restart=on-failure`
  - `SuccessExitStatus=0`
  - `RestartPreventExitStatus=0`
  - `RestartSec=5s`, `Type=simple`, `Environment=PYTHONUNBUFFERED=1`

### C. venv 권한 보정
- `.venv/**` 및 `site-packages/ccxt/**` 읽기/실행 권한 부여

---

## 검증(Verification)
- 런타임 체크:
  - `exchange.id=binanceusdm`, `options.defaultType=future`
  - `BTC/USDT:USDT ∈ markets`, `market(symbol)['id']=BTCUSDT`
- 최근 2~3분 `journalctl`:
  - `KeyError`, `traceback` 키워드 **무출력**
  - restart counter 증가 **중단**
- 거래 재개 대기(정상 신호 발생 시 진입)

---

## 재발 방지/후속(Action Items)
### 1) 시작 가드(코드)
- 부팅 시 아래 항목 검증 후 미통과 시 **fail-fast** + 명시 로그
  - `exchange.id == "binanceusdm"`
  - `options.defaultType == "future"`
  - `symbol in exchange.markets`
  - `exchange.market(symbol).get("id")` 존재

### 2) 심볼 정규화 유틸(코드)
- 입력 표기(`BTCUSDT`, `BTC/USDT`, `BTC/USDT:USDT`) → **USDT-M 표준**으로 일관 매핑

### 3) 다른 유닛 점검
- 현물/선물 혼용 여부 재확인(SOL 포함)
- 민감정보(웹훅 등) 레포/로그 노출 점검

---

## 오늘의 전략 파라미터 상태(변경 없음)
- **BTC:** `ATR_GATE_MULT=1.02`, `ENTRY_COOLDOWN_S=600`
- **ETH:** `ATR_GATE_MULT=1.06`, `ENTRY_RETEST_TOL_PCT=0.10`, `ENTRY_RETEST_WINDOW_S=150`, `ENTRY_COOLDOWN_S=300`
> 거래 부재의 원인이 인프라/설정 문제였으므로 **전략 수정 보류**. 안정화 후 24–48h 데이터로 재평가.
